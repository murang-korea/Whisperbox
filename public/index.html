<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ“œ WhisperBox</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="header">
    ğŸ“œ WhisperBox
    <div id="userArea" style="float:right"></div>
  </div>

  <div class="container">
    <button id="writeBtn" style="background-color:#ffb366;margin-bottom:10px;">âœï¸ ìƒˆ ê¸€ ì‘ì„±</button>
    <div id="postList"></div>
  </div>

  <script src="script.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    const user = await showCurrentUser();

    const userArea = document.getElementById("userArea");
    const writeBtn = document.getElementById("writeBtn");

    // ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ
    if (user) {
      userArea.innerHTML = `${user.username}ë‹˜ | <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>`;
      document.getElementById("logoutBtn").onclick = logout;
    } else {
      userArea.innerHTML = `<a href="login.html" style="color:white;">ë¡œê·¸ì¸</a>`;
    }

    // ê¸€ì“°ê¸° ë²„íŠ¼ ë™ì‘
    writeBtn.addEventListener("click", () => {
      if (!user) {
        alert("ë¡œê·¸ì¸ í›„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
        location.href = "login.html";
      } else {
        location.href = "write.html";
      }
    });

    // ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    try {
      const res = await fetch("/api/posts");
      const posts = await res.json();
      const postList = document.getElementById("postList");

      if (!Array.isArray(posts) || posts.length === 0) {
        postList.innerHTML = "<p>ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      postList.innerHTML = posts.map(p => `
        <div class="card" style="margin-top:10px;cursor:pointer" onclick="location.href='view.html?id=${p.id}'">
          <h3>${p.title}</h3>
          <p>${p.content.slice(0, 80)}...</p>
          <small>âœï¸ ${p.author} | ğŸ•’ ${new Date(p.date).toLocaleString()}</small>
        </div>
      `).join("");
    } catch (err) {
      console.error(err);
      alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });
  </script>
</body>
</html>
