<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>📖 WhisperBox 글보기</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="header">
    📖 WhisperBox
    <div id="userArea" style="float:right"></div>
  </div>

  <div class="container">
    <div id="postArea" class="card"></div>

    <h3>💬 댓글</h3>
    <div id="commentList"></div>

    <textarea id="commentInput" rows="3" placeholder="댓글을 입력하세요" style="width:100%;margin-top:10px;"></textarea>
    <button id="commentBtn" style="margin-top:5px;background-color:#ffb366;">댓글 작성</button>
  </div>

  <script src="script.js"></script>
  <script>
  (async function(){
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const user = await showCurrentUser();
    if(user){
      userArea.innerHTML = `${user.username}님 | <a href="#" id="logoutBtn">로그아웃</a>`;
      document.getElementById("logoutBtn").onclick = logout;
    } else {
      userArea.innerHTML = `<a href="login.html">로그인</a>`;
    }

    const res = await fetch(`/api/posts/${id}`);
    const post = await res.json();
    if(!res.ok) return alert("게시글을 불러오지 못했습니다.");

    document.getElementById("postArea").innerHTML = `
      <h2>${post.title}</h2>
      <p>${post.content}</p>
      <small>✏️ ${post.author} | ${new Date(post.date).toLocaleString()}</small>
    `;

    const list = document.getElementById("commentList");
    if(post.comments.length === 0){
      list.innerHTML = "<p>아직 댓글이 없습니다.</p>";
    }else{
      list.innerHTML = post.comments.map(c=>`
        <div class="card" style="margin-top:5px;">
          <p>${c.content}</p>
          <small>💬 ${c.author} | ${new Date(c.date).toLocaleString()}</small>
        </div>
      `).join("");
    }

    document.getElementById("commentBtn").addEventListener("click", async ()=>{
      if(!user){
        alert("로그인이 필요합니다!");
        location.href = "login.html";
        return;
      }

      const content = commentInput.value.trim();
      if(!content) return alert("댓글 내용을 입력하세요.");

      const res2 = await fetch(`/api/posts/${id}/comments`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({content})
      });
      const data = await res2.json();
      if(res2.ok){
        alert("댓글이 작성되었습니다!");
        location.reload();
      } else alert(data.error || "댓글 작성 실패");
    });
  })();
  </script>
</body>
</html>
