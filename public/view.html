<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ“– WhisperBox ê¸€ë³´ê¸°</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="header">
    ğŸ“– WhisperBox
    <div id="userArea" style="float:right"></div>
  </div>

  <div class="container">
    <div id="postArea" class="card"></div>

    <h3>ğŸ’¬ ëŒ“ê¸€</h3>
    <div id="commentList"></div>

    <textarea id="commentInput" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%;margin-top:10px;"></textarea>
    <button id="commentBtn" style="margin-top:5px;background-color:#ffb366;">ëŒ“ê¸€ ì‘ì„±</button>
  </div>

  <script src="script.js"></script>
  <script>
  (async function(){
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const user = await showCurrentUser();
    if(user){
      userArea.innerHTML = `${user.username}ë‹˜ | <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>`;
      document.getElementById("logoutBtn").onclick = logout;
    } else {
      userArea.innerHTML = `<a href="login.html">ë¡œê·¸ì¸</a>`;
    }

    const res = await fetch(`/api/posts/${id}`);
    const post = await res.json();
    if(!res.ok) return alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

    document.getElementById("postArea").innerHTML = `
      <h2>${post.title}</h2>
      <p>${post.content}</p>
      <small>âœï¸ ${post.author} | ${new Date(post.date).toLocaleString()}</small>
    `;

    const list = document.getElementById("commentList");
    if(post.comments.length === 0){
      list.innerHTML = "<p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    }else{
      list.innerHTML = post.comments.map(c=>`
        <div class="card" style="margin-top:5px;">
          <p>${c.content}</p>
          <small>ğŸ’¬ ${c.author} | ${new Date(c.date).toLocaleString()}</small>
        </div>
      `).join("");
    }

    document.getElementById("commentBtn").addEventListener("click", async ()=>{
      if(!user){
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
        location.href = "login.html";
        return;
      }

      const content = commentInput.value.trim();
      if(!content) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

      const res2 = await fetch(`/api/posts/${id}/comments`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({content})
      });
      const data = await res2.json();
      if(res2.ok){
        alert("ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.reload();
      } else alert(data.error || "ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨");
    });
  })();
  </script>
</body>
</html>
